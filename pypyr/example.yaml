# pypyr pipeline definition file
# This pipeline will log errors to Sentry if any step fails.

steps:
  - name: pypyr.steps.set
    comment: "Set Configurations"
    in:
      set:
        ROS_DOMAIN_ID: 2
        IP: 192.168.20.96
        PORT: 4040
        VIN: C4RF117S7U0000002
        IS_CONTROLLED_BY_USER: 0
        SERVER_IP: 0.0.0.0
        SERVER_PORT: 12345
  - name: pypyr.steps.cmd
    comment: "Stop all running ROS2 processes"
    in:
      cmd:
        run: ./reco-stop.sh
        cwd: /home/ubuntu/car-ops/ros2
        stdout: /reco/log/reco-stop.log
        stderr: /reco/log/reco-stop.log

  - name: pypyr.steps.cmd
    comment: "Pull latest ROS2 code from GitHub"
    in:
      cmd:
        run: git pull
        cwd: /home/ubuntu/ros2_ws
        stdout: /reco/log/git-pull.log
        stderr: /reco/log/git-pull.log

  - name: pypyr.steps.cmd
    comment: "Build ROS2 code"
    in:
      cmd:
        run: colcon build
        cwd: /home/ubuntu/ros2_ws
        stdout: /reco/log/colcon-build.log
        stderr: /reco/log/colcon-build.log

  - name: pypyr.steps.filewrite
    comment: "Write config udp_client_config"
    in:
      fileWrite:
        path: /home/ubuntu/ros2_ws/src/car_to_backend/src/udp_client_config
        append: False
        payload: "{IP}\n{PORT}\n{VIN}\n{IS_CONTROLLED_BY_USER}"

  - name: pypyr.steps.filewrite
    comment: "Write config udp_server_config"
    in:
      fileWrite:
        path: /home/ubuntu/ros2_ws/src/car_to_backend/src/udp_server_config
        append: False
        payload: "{SERVER_IP}\n{SERVER_PORT}"
  
  - name: pypyr.steps.filewrite
    comment: "Set the ROS_DOMAIN_ID"
    in:
      fileWrite:
        path: /home/ubuntu/ros_domain_id
        append: False
        payload: "{ROS_DOMAIN_ID}"
